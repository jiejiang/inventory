'use strict';window.postOrdersApp=angular.module('postOrdersApp',['ngRoute','restangular','ui.bootstrap','ngFileUpload','ngCookies']).config(['$interpolateProvider',function($interpolateProvider){$interpolateProvider.startSymbol('{[');$interpolateProvider.endSymbol(']}');}]).config(['$routeProvider','RestangularProvider',function($routeProvider,RestangularProvider){RestangularProvider.setBaseUrl(angular.element('body').attr('api_prefix'));var partialsDir='static/partials/';$routeProvider.when('/batch-order',{templateUrl:partialsDir+'batch-order.html',controller:'BatchOrder'}).when('/retract-orders',{templateUrl:partialsDir+'retract-orders.html',controller:'RetractOrders'}).when('/new-order-numbers',{templateUrl:partialsDir+'new-order-numbers.html',controller:'NewOrderNumbers'}).when('/scan-barcode',{templateUrl:partialsDir+'scan-barcode.html',controller:'ScanBarcode'}).when('/merge-excel',{templateUrl:partialsDir+'merge-excel.html',controller:'MergeExcel'}).otherwise({redirectTo:'/batch-order'});}]);$(function(){$('#side-menu').metisMenu();});'use strict';postOrdersApp.controller('Frame',['$scope','$location','$window','$filter','$log','Restangular','$cookies',function($scope,$location,$window,$filter,$log,Restangular,$cookies){$scope.alerts=[];$scope.addAlert=function(message){$scope.alerts.push({type:'danger',msg:message});};$scope.closeAlert=function(index){$scope.alerts.splice(index,1);};$scope.clearAlerts=function(){$scope.alerts.length=0;};$scope.isActive=function(route){return $location.path().match("^"+route);}
$scope.api_prefix=angular.element('body').attr('api_prefix');$scope.route_prefix=angular.element('body').attr('route_prefix');$scope.hrefs=['/'+$scope.route_prefix+'/admin/admin.unused_standard_order','/'+$scope.route_prefix+'/admin/admin.unused_fast_track_order'];$scope.query_stats=function(){Restangular.one('orders').get().then(function(data){$scope.stats=data.stats;var alert_thresholds=data.alert_thresholds.map(function(item){return parseInt(item,10)}).sort(function(a,b){return a-b;});angular.forEach($scope.stats,function(value,key){var alerted=false;angular.forEach(alert_thresholds,function(v,k){var cookie_key=key+v;if(value.unused<v&&key!=="圆通单号"){if(!alerted){if(typeof($cookies.get(cookie_key))==='undefined'){$window.alert("提醒: "+key+' 不足'+v+", 请尽快上载!");alerted=true;$cookies.put(cookie_key,true)}}}else{$cookies.remove(cookie_key);}});});$scope.used_count=data.used_count;$scope.unretracted_count=data.unretracted_count;$scope.retracted_count=data.retracted_count;},function(data){$scope.clearAlerts();$scope.addAlert("Connection error, please refresh the page...");});};}]);'use strict';postOrdersApp.controller('BatchOrder',['$scope','Upload','BatchOrderJob','$location','$timeout','$window','$log','Restangular',function($scope,Upload,BatchOrderJob,$location,$timeout,$window,$log,Restangular){$scope.initialize=function(){$scope.route='';$scope.job=BatchOrderJob;$scope.running=false;};$scope.initialize();$scope.query_stats();$scope.onSelectRoute=function(){$scope.job=BatchOrderJob;$scope.running=false;};$scope.$watch('file',function(){$scope.clearAlerts();$scope.upload($scope.file);});$scope.upload=function(file){if(file!=undefined){$scope.job.clear();$scope.running=true;(function(){$scope.job.upload_file={name:file.name,percentage:0};Upload.upload({url:$scope.$parent.api_prefix+'/batch-order',file:file,data:{route:$scope.route},}).progress(function(evt){$scope.job.upload_file.percentage=parseInt(100.0*evt.loaded/evt.total);}).success(function(data,status,headers,config){$scope.job.id=data.id;$scope.job.data={status:'Waiting',percentage:0,};(function tick(){$scope.job.get().then(function(data){$scope.job.setData(data);if(!data.finished&&$scope.job.id){$timeout(tick,3000);}else{$scope.running=false;if(!data.success){$scope.addAlert(data.message);}else{}}
$scope.query_stats();},function(data){if($scope.job.id){$scope.clearAlerts();$scope.addAlert("Connection error, retrying...");$timeout(tick,5000);}});})();}).error(function(data){$scope.job.clear();$scope.addAlert(data.message);$scope.query_stats();$scope.running=false;});})();}};}]);'use strict';postOrdersApp.factory('BatchOrderJob',['Restangular',function(Restangular){return{id:null,upload_file:null,data:null,clear:function(){this.id=null;this.upload_file=null;this.data=null;},get:function(){return Restangular.one('job',this.id).get();},setData:function(data){this.data=data;},};}]);'use strict';postOrdersApp.controller('NewOrderNumbers',['$scope','Upload','$location','$timeout','$window','$log',function($scope,Upload,$location,$timeout,$window,$log){$scope.running=false;$scope.$watch('file',function(){$scope.clearAlerts();$scope.existing_order_numbers=null;$scope.inserted_order_numbers=null;$scope.invalid_order_numbers=null;$scope.running=false;$scope.upload($scope.file);});$scope.upload=function(file){if(file!=undefined){(function(){$scope.upload_file={name:file.name,percentage:0};$scope.running=true;Upload.upload({url:$scope.$parent.api_prefix+'/orders',file:file,}).progress(function(evt){$scope.upload_file.percentage=parseInt(100.0*evt.loaded/evt.total);}).success(function(data,status,headers,config){$scope.inserted_order_numbers=data.inserted_order_numbers;$scope.invalid_order_numbers=data.invalid_order_numbers;$scope.existing_order_numbers=data.existing_order_numbers;$scope.running=false;}).error(function(data){$scope.addAlert(data.message);$scope.running=false;});})();}};}]);'use strict';postOrdersApp.controller('RetractOrders',['$scope','Upload','$location','$timeout','$window','$log',function($scope,Upload,$location,$timeout,$window,$log){$scope.running=false;$scope.retraction_id=null;$scope.is_redo=false;$scope.query_stats();$scope.$watch('file',function(){$scope.clearAlerts();$scope.order_numbers=null;$scope.retraction_id=null;$scope.running=false;$scope.upload($scope.file);});$scope.upload=function(file){if(file!=undefined){(function(){$scope.upload_file={name:file.name,percentage:0};$scope.running=true;Upload.upload({url:$scope.$parent.api_prefix+'/retract-orders',file:file,data:{route:$scope.route,is_redo:$scope.is_redo},}).progress(function(evt){$scope.upload_file.percentage=parseInt(100.0*evt.loaded/evt.total);}).success(function(data,status,headers,config){$scope.order_numbers=data.order_numbers;$scope.retraction_id=data.id;$scope.running=false;$scope.query_stats();}).error(function(data){$scope.addAlert(data.message);$scope.running=false;$scope.query_stats();});})();}};}]);'use strict';postOrdersApp.controller('ScanBarcode',['$scope','Upload','ScanOrder','RouteInfo','$http','$cacheFactory','$window','$log',function($scope,Upload,ScanOrder,RouteInfo,$http,$cacheFactory,$window,$log){$scope.initialize=function(){$scope.validScan=[];$scope.invalidScan=[];$scope.barcodeStorage=new Object();$scope.receiverCount=new Object();$scope.dutiable_count=0;$scope.dutiable_category_count=0;$scope.exportBarcodes="";$scope.clearAlerts();$scope.running=false;$scope.preScansList=[];};$scope.initialize();$scope.barcode_size=function(){var count=0;for(var k in $scope.barcodeStorage)if($scope.barcodeStorage.hasOwnProperty(k))++count;return count;}
$scope.dutiablePercentage=function(){if($scope.dutiable_category_count>0){return parseFloat($scope.dutiable_count*100/$scope.dutiable_category_count).toFixed(1);}
return 0}
$scope.onSelectRoute=function(){$scope.initialize();if($scope.route){RouteInfo.get($scope.route).then(function(data){$scope.route_info=data;},function(data){$scope.clearAlerts();$scope.addAlert("Connection error, please retry");});}};$scope.cache=$cacheFactory.get('scan-prompt')||$cacheFactory('scan-prompt');$scope.playAudio=function(sentence){var audio=$scope.cache.get(sentence);if(!audio){audio=new Audio('/'+$scope.route_prefix+'/tts/'+sentence);$scope.cache.put(sentence,audio);}
audio.play();};function getActiveClass(index){if(index==0){return"animated infinite flash";}
return""};function getInactiveClass(index){return""};$scope.onReset=function(){$scope.initialize();$scope.route="";};$scope.submit_url='/'+$scope.route_prefix+'/scan-export';$scope.onSubmit=function(){$scope.exportBarcodes=$scope.validScan.map(function(obj){return obj.barcode;}).join(",");};$scope.removeValidScan=function(index){var barcode=$scope.validScan[index].barcode;var id_number=$scope.barcodeStorage[barcode].receiver_id_number;if($scope.receiverCount[id_number]>0){$scope.receiverCount[id_number]-=1;}
if($scope.barcodeStorage[barcode].is_dutiable_category){$scope.dutiable_category_count--;if($scope.barcodeStorage[barcode].dutiable){$scope.dutiable_count--;}}
delete $scope.barcodeStorage[barcode];if(index===$scope.validScan.length-1){$scope.getAcceptClass=getInactiveClass;}
$scope.validScan.splice(index,1);};$scope.onScan=function(barcode){if($scope.barcodeStorage.hasOwnProperty(barcode)){var message='Error: Barcode Duplicated';$scope.invalidScan.push({barcode:barcode,prompt:message});$scope.playAudio(message);$scope.getAcceptClass=getInactiveClass;$scope.getRejectClass=getActiveClass;}else{ScanOrder.get(barcode,$scope.route).then(function(data){var message=null;if(data.success){var receiver_id_number=data.receiver_id_number;if(!$scope.receiverCount.hasOwnProperty(receiver_id_number)){$scope.receiverCount[receiver_id_number]=0;}
if($scope.route_info['max_order_number_per_receiver']&$scope.receiverCount[receiver_id_number]>=$scope.route_info['max_order_number_per_receiver']){message="Error: Exceeded Personal Package Allowance: "+$scope.route_info['max_order_number_per_receiver'];$scope.invalidScan.push({barcode:barcode,prompt:message});$scope.getAcceptClass=getInactiveClass;$scope.getRejectClass=getActiveClass;}else{$scope.barcodeStorage[barcode]=data;if($scope.barcodeStorage[barcode].is_dutiable_category){$scope.dutiable_category_count++;if($scope.barcodeStorage[barcode].dutiable){$scope.dutiable_count++;}}
$scope.validScan.push({barcode:barcode,prompt:data.message});message=data.message;$scope.receiverCount[receiver_id_number]+=1;$scope.getAcceptClass=getActiveClass;$scope.getRejectClass=getInactiveClass;}}else{message=data.message;$scope.invalidScan.push({barcode:barcode,prompt:message});$scope.getAcceptClass=getInactiveClass;$scope.getRejectClass=getActiveClass;}
if(message){$scope.playAudio(message);}},function(data){$scope.clearAlerts();$scope.addAlert("Connection error, please retry");$scope.getAcceptClass=getInactiveClass;$scope.getRejectClass=getInactiveClass;});}};$scope.barcodeKeyPressed=function($event){var keyCode=$event.which||$event.keyCode;if(keyCode==13&&$scope.barcode){var barcode=$scope.barcode;$scope.barcode='';$scope.onScan(barcode);}};$scope.$watch('file',function(){$scope.clearAlerts();$scope.running=false;$scope.upload($scope.file);});$scope.upload=function(file){if(file!=undefined){(function(){$scope.running=true;Upload.upload({url:$scope.$parent.api_prefix+'/retract-orders',file:file,data:{route:$scope.route,dryrun:true},}).progress(function(evt){}).success(function(data,status,headers,config){var _barcodeStorage=new Object();var _receiverCount=new Object();for(var i=0,len=data.length;i<len;i++){var scan=data[i];if(_barcodeStorage.hasOwnProperty(scan.barcode)||$scope.barcodeStorage.hasOwnProperty(scan.barcode)){$scope.addAlert('Loading failed with duplicated scanned barcode: '+scan.barcode);return;}
if(!_receiverCount.hasOwnProperty(scan.receiver_id_number)){_receiverCount[scan.receiver_id_number]=0;}
if($scope.route_info['max_order_number_per_receiver']&_receiverCount[scan.receiver_id_number]>=$scope.route_info['max_order_number_per_receiver']){$scope.addAlert('Loading failed with exceeded personal allowance ('
+$scope.route_info['max_order_number_per_receiver']+'): '+scan.receiver_id_number);return;}
_barcodeStorage[scan.barcode]=scan;_receiverCount[scan.receiver_id_number]+=1;}
if($scope.route_info['max_order_number_per_receiver']){for(var receiver_id_number in _receiverCount){if(_receiverCount.hasOwnProperty(receiver_id_number)&$scope.receiverCount.hasOwnProperty(receiver_id_number)){if(_receiverCount[receiver_id_number]+$scope.receiverCount[receiver_id_number]>$scope.route_info['max_order_number_per_receiver']){$scope.addAlert('Loading failed with exceeded personal allowance ('
+$scope.route_info['max_order_number_per_receiver']+'): '+receiver_id_number)
return;}}}}
var scans=[];for(var i=0,len=data.length;i<len;i++){var scan=data[i];$scope.barcodeStorage[scan.barcode]=scan;console.log(scan);if($scope.barcodeStorage[scan.barcode].is_dutiable_category){$scope.dutiable_category_count++;if($scope.barcodeStorage[scan.barcode].dutiable){$scope.dutiable_count++;}}
if(!$scope.receiverCount.hasOwnProperty(scan.receiver_id_number)){$scope.receiverCount[scan.receiver_id_number]=0;}
$scope.receiverCount[scan.receiver_id_number]+=1;scans.push(scan);}
$scope.preScansList.push({name:file.name,scans:scans,visible:false});}).error(function(data){$scope.addAlert(data.message);}).finally(function(){$scope.running=false;});})();}};$scope.togglePreScans=function(index){if(index<$scope.preScansList.length){$scope.preScansList[index].visible=!$scope.preScansList[index].visible;}};}]);'use strict';postOrdersApp.factory('ScanOrder',['Restangular',function(Restangular){return{get:function(id,route){return Restangular.one('scan-order',id).get({route:route});},};}]);'use strict';postOrdersApp.factory('RouteInfo',['Restangular',function(Restangular){return{get:function(route){return Restangular.one('route-info',route).get();},};}]);'use strict';postOrdersApp.controller('MergeExcel',['$scope','$window','$log',function($scope,$window,$log){$scope.clearAlerts();$scope.submit_url='/'+$scope.route_prefix+'/merge-excel';var els=angular.element('.flash-message');angular.forEach(els,function(el){$scope.addAlert(angular.element(el).text());el.remove();});angular.element('.div-flash-message').remove();$scope.onSubmit=function(){$scope.clearAlerts();};}]);